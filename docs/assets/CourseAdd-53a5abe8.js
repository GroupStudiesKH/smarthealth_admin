import{_ as z,i as Q,r as u,j as G,k as V,o as r,c as n,b as e,l as _,d as J,m,e as v,g as T,t as i,a as d,v as w,y as K,n as X,F as Y}from"./index-b90c0ad9.js";import{F as Z,N as $,_ as ee}from"./sidebar-87f173a3.js";import{C as se,U as oe}from"./UploadAdapter-e6cd9b32.js";import{a as x}from"./api-service-e3b33b42.js";import{s as ae}from"./vue-multiselect.css_vue_type_style_index_0_src_true_lang-9c8cd725.js";const te={components:{Footer:Z,Navbar:$,Sidebar:ee,multiselect:ae},setup(){const k=Q(),s=u(null),h=u(null),o=u(!1),C=u(""),I=u({}),U=u(!1),y=u(!1),g=u(""),l=u({title:"",instructors:[],subtitle:"",has_certificate:!1,language:"",description:"",category:null,tags:[],is_mandatory:!1,credit:0,level:"beginner",status:"publish",coverImage:null}),a=u([]),P=u([]),F=u([]),L=({name:t,position:c})=>`${t} (${c})`,N=async()=>{try{const t=await x.getInstructorsOption();F.value=t.map(c=>({id:c.id,name:c.name,position:c.position||""}))}catch(t){console.log(t)}},A=async()=>{try{const t=await x.getTags({type:"tag"});P.value=t.data}catch(t){console.log(t)}},q=async()=>{try{const t=await x.getTags({type:"category"});a.value=t.data}catch(t){console.log(t)}},R=async()=>{var t,c,b;try{const f={title:l.value.title,subtitle:l.value.subtitle,has_certificate:l.value.has_certificate,language:l.value.language,instructors:l.value.instructors.map(p=>p.id),description:l.value.description,tags:l.value.tags.map(p=>p.id),status:l.value.status,is_mandatory:l.value.is_mandatory,credit:l.value.credit,coverImage:l.value.coverImage,level:l.value.level,categories:(t=l.value.category)!=null&&t.id?[l.value.category.id]:[]};await x.createCourse(f),k.push({name:"courseList"})}catch(f){if(((b=(c=f.response)==null?void 0:c.data)==null?void 0:b.status)==="error")if(f.response.data.content){const p={};for(const[W,S]of Object.entries(f.response.data.content))p[W]=Array.isArray(S)?S[0].replace(/[\[\]"]/g,""):S;I.value=p;const O=Object.values(p).join("<br/>");M("新增失敗："+(O||"未知錯誤"))}else M("新增失敗："+(f.response.data.message||"儲存失敗"));else M("儲存失敗")}finally{U.value=!1}},M=t=>{g.value=t,y.value=!0},j=t=>{g.value=t,y.value=!0},E=()=>{y.value=!1},H=async t=>{const c=t.target.files[0];if(c)try{o.value=!0,C.value="上傳中...";const b=await x.courseImgUpload(c);l.value.coverImage=b.url,h.value=b.url,C.value="上傳完成"}catch(b){C.value="上傳失敗："+b.message,l.value.coverImage="",t.target.value=""}finally{o.value=!1}},B=()=>{h.value=null,l.value.coverImage=null};G(async()=>{try{A(),q(),N(),s.value=await se.create(document.querySelector("#editor"),{removePlugins:["Markdown"],extraPlugins:[D],toolbar:["heading","|","bold","italic","link","bulletedList","numberedList","blockQuote","imageUpload"],heading:{options:[{model:"paragraph",title:"Paragraph",class:"ck-heading_paragraph"},{model:"heading1",view:"h2",title:"Heading 1",class:"ck-heading_heading1"},{model:"heading2",view:"h3",title:"Heading 2",class:"ck-heading_heading2"}]}}).then(t=>(t.model.document.on("change:data",()=>{l.value.description=t.getData()}),t))}catch(t){console.error("初始化失敗:",t)}});function D(t){t.plugins.get("FileRepository").createUploadAdapter=c=>new oe(c)}return{course:l,categories:a,availableTags:P,saveCourse:R,handleCoverImageUpload:H,removeCoverImage:B,coverImagePreview:h,editor:s,availableInstructors:F,nameWithPos:L,errors:I,isLoading:U,showModal:y,modalMessage:g,showErrorModal:M,closeModal:E,showSuccessModal:j}}},le={class:"main-wrapper"},re={class:"page-wrapper"},ne={class:"page-content"},ie={class:"row mb-4"},de={class:"col-12 mx-auto stretch-card"},ce={class:"card"},ue={class:"card-body"},me={class:"mb-3"},ve={key:0,class:"invalid-feedback"},ge={class:"mb-3"},be={key:0,class:"invalid-feedback"},pe={class:"mb-3"},ye={key:0,class:"invalid-feedback"},fe={class:"mb-3"},_e={key:0,class:"invalid-feedback"},ke={class:"mb-3"},we={key:0,class:"invalid-feedback"},xe={class:"row"},he={class:"mb-3 col-6"},Ce={key:0,class:"invalid-feedback"},Ue={class:"mb-3 col-6"},Me={key:0,class:"invalid-feedback"},Ve={class:"mb-3 col-6"},Ie={key:0,class:"invalid-feedback"},Se={class:"mb-3 col-6"},Te={key:0,class:"invalid-feedback"},Pe={class:"mb-3"},Fe={key:0,class:"invalid-feedback"},Le={class:"mb-3"},Ne={key:0,class:"mb-2"},Ae=["src"],qe={class:"input-group"},Re={key:1,class:"text-muted mt-2"},je={class:"mb-3"},Ee={key:0,class:"invalid-feedback"},He={class:"mb-3"},Be={key:0,class:"invalid-feedback"},De={class:"modal-dialog"},Oe={class:"modal-content"},We={class:"modal-header"},ze=["innerHTML"],Qe={class:"modal-footer"},Ge={key:0,class:"modal-backdrop"};function Je(k,s,h,o,C,I){const U=V("Sidebar"),y=V("Navbar"),g=V("multiselect"),l=V("Footer");return r(),n(Y,null,[e("div",le,[_(U),e("div",re,[_(y),e("div",ne,[e("div",ie,[e("div",de,[e("div",ce,[e("div",ue,[s[37]||(s[37]=e("h6",{class:"card-title"},"新增課程",-1)),e("form",{onSubmit:s[14]||(s[14]=J((...a)=>o.saveCourse&&o.saveCourse(...a),["prevent"]))},[e("div",me,[s[17]||(s[17]=e("label",{class:"form-label"},[m("課程標題 "),e("span",{class:"text-danger"},"*")],-1)),v(e("input",{type:"text",class:"form-control","onUpdate:modelValue":s[0]||(s[0]=a=>o.course.title=a),required:""},null,512),[[T,o.course.title]]),o.errors.title?(r(),n("div",ve,i(o.errors.title),1)):d("",!0)]),e("div",ge,[s[18]||(s[18]=e("label",{class:"form-label"},"副標題",-1)),v(e("input",{"onUpdate:modelValue":s[1]||(s[1]=a=>o.course.subtitle=a),type:"text",class:"form-control",maxlength:"100"},null,512),[[T,o.course.subtitle]]),o.errors.subtitle?(r(),n("div",be,i(o.errors.subtitle),1)):d("",!0)]),e("div",pe,[s[20]||(s[20]=e("label",{class:"form-label"},[m("是否有證書 "),e("span",{class:"text-danger"},"*")],-1)),v(e("select",{"onUpdate:modelValue":s[2]||(s[2]=a=>o.course.has_certificate=a),class:"form-select",required:""},s[19]||(s[19]=[e("option",{value:"0"},"否",-1),e("option",{value:"1"},"是",-1)]),512),[[w,o.course.has_certificate]]),o.errors.has_certificate?(r(),n("div",ye,i(o.errors.has_certificate),1)):d("",!0)]),e("div",fe,[s[22]||(s[22]=e("label",{class:"form-label"},[m("課程語言 "),e("span",{class:"text-danger"},"*")],-1)),v(e("select",{"onUpdate:modelValue":s[3]||(s[3]=a=>o.course.language=a),class:"form-select",required:""},s[21]||(s[21]=[e("option",{value:""},"請選擇語言",-1),e("option",{value:"中文"},"中文",-1),e("option",{value:"英文"},"英文",-1)]),512),[[w,o.course.language]]),o.errors.language?(r(),n("div",_e,i(o.errors.language),1)):d("",!0)]),e("div",ke,[s[24]||(s[24]=e("label",{class:"form-label"},[m("課程等級 "),e("span",{class:"text-danger"},"*")],-1)),v(e("select",{"onUpdate:modelValue":s[4]||(s[4]=a=>o.course.level=a),class:"form-select",required:""},s[23]||(s[23]=[e("option",{value:"beginner"},"初級",-1),e("option",{value:"intermediate"},"中級",-1),e("option",{value:"advanced"},"高級",-1),e("option",{value:"all_levels"},"全等級",-1)]),512),[[w,o.course.level]]),o.errors.level?(r(),n("div",we,i(o.errors.level),1)):d("",!0)]),e("div",xe,[e("div",he,[s[25]||(s[25]=e("label",{class:"form-label"},[m("講師 "),e("span",{class:"text-danger"},"*")],-1)),_(g,{modelValue:o.course.instructors,"onUpdate:modelValue":s[5]||(s[5]=a=>o.course.instructors=a),options:o.availableInstructors,"custom-label":o.nameWithPos,placeholder:"選擇講師",label:"name","track-by":"name",multiple:!0},{singleLabel:K(({option:a})=>[e("strong",null,i(a.name),1),m(" ("+i(a.position)+") ",1)]),_:1},8,["modelValue","options","custom-label"]),o.errors.language?(r(),n("div",Ce,i(o.errors.language),1)):d("",!0)]),e("div",Ue,[s[27]||(s[27]=e("label",{class:"form-label"},[m("課程屬性 "),e("span",{class:"text-danger"},"*")],-1)),v(e("select",{class:"form-control","onUpdate:modelValue":s[6]||(s[6]=a=>o.course.is_mandatory=a)},s[26]||(s[26]=[e("option",{value:"1"},"必修",-1),e("option",{value:"0"},"選修",-1)]),512),[[w,o.course.is_mandatory]]),o.errors.is_mandatory?(r(),n("div",Me,i(o.errors.is_mandatory),1)):d("",!0)]),e("div",Ve,[s[28]||(s[28]=e("label",{class:"form-label"},[m("學分數 "),e("span",{class:"text-danger"},"*")],-1)),v(e("input",{type:"number",class:"form-control","onUpdate:modelValue":s[7]||(s[7]=a=>o.course.credit=a),min:"0",step:"1"},null,512),[[T,o.course.credit]]),o.errors.credit?(r(),n("div",Ie,i(o.errors.credit),1)):d("",!0)]),e("div",Se,[s[29]||(s[29]=e("label",{class:"form-label"},[m("課程分類 "),e("span",{class:"text-danger"},"*")],-1)),_(g,{modelValue:o.course.category,"onUpdate:modelValue":s[8]||(s[8]=a=>o.course.category=a),options:o.categories,placeholder:"選擇分類",label:"name","track-by":"id"},null,8,["modelValue","options"]),o.errors.category?(r(),n("div",Te,i(o.errors.category),1)):d("",!0)])]),e("div",Pe,[s[30]||(s[30]=e("label",{class:"form-label"},[m("課程標籤 "),e("span",{class:"text-danger"},"*")],-1)),_(g,{modelValue:o.course.tags,"onUpdate:modelValue":s[9]||(s[9]=a=>o.course.tags=a),options:o.availableTags,placeholder:"選擇標籤",label:"name","track-by":"id",multiple:!0},null,8,["modelValue","options"]),o.errors.tags?(r(),n("div",Fe,i(o.errors.tags),1)):d("",!0)]),e("div",Le,[s[31]||(s[31]=e("label",{class:"form-label"},"課程封面",-1)),o.coverImagePreview?(r(),n("div",Ne,[e("img",{src:o.coverImagePreview,alt:"封面預覽",class:"img-thumbnail",style:{"max-width":"200px"}},null,8,Ae),e("button",{type:"button",class:"btn btn-danger btn-sm ms-2",onClick:s[10]||(s[10]=(...a)=>o.removeCoverImage&&o.removeCoverImage(...a))}," 移除封面 ")])):d("",!0),e("div",qe,[e("input",{type:"file",class:"form-control",accept:"image/*",onChange:s[11]||(s[11]=(...a)=>o.handleCoverImageUpload&&o.handleCoverImageUpload(...a))},null,32)]),k.isUploading?(r(),n("div",Re,i(k.uploadStatusText),1)):d("",!0)]),e("div",je,[s[32]||(s[32]=e("label",{class:"form-label"},[m("課程描述 "),e("span",{class:"text-danger"},"*")],-1)),s[33]||(s[33]=e("div",{id:"editor"},null,-1)),o.errors.is_mandatory?(r(),n("div",Ee,i(o.errors.is_mandatory),1)):d("",!0)]),e("div",He,[s[35]||(s[35]=e("label",{class:"form-label"},[m("課程狀態 "),e("span",{class:"text-danger"},"*")],-1)),v(e("select",{class:"form-select","onUpdate:modelValue":s[12]||(s[12]=a=>o.course.status=a),required:""},s[34]||(s[34]=[e("option",{value:"publish"},"公開",-1),e("option",{value:"unpublish"},"非公開",-1)]),512),[[w,o.course.status]]),o.errors.status?(r(),n("div",Be,i(o.errors.status),1)):d("",!0)]),s[36]||(s[36]=e("button",{type:"submit",class:"btn btn-primary me-2"}," 建立課程 ",-1)),e("button",{type:"button",class:"btn btn-light",onClick:s[13]||(s[13]=a=>k.router.push({name:"courseList"}))}," 取消 ")],32)])])])])]),_(l)])]),e("div",{class:X(["modal",{"d-block":o.showModal}]),tabindex:"-1"},[e("div",De,[e("div",Oe,[e("div",We,[s[38]||(s[38]=e("h5",{class:"modal-title"},"提示",-1)),e("button",{type:"button",class:"btn-close",onClick:s[15]||(s[15]=(...a)=>o.closeModal&&o.closeModal(...a))})]),e("div",{class:"modal-body",innerHTML:o.modalMessage},null,8,ze),e("div",Qe,[e("button",{type:"button",class:"btn btn-secondary",onClick:s[16]||(s[16]=(...a)=>o.closeModal&&o.closeModal(...a))},"關閉")])])])],2),o.showModal?(r(),n("div",Ge)):d("",!0)],64)}const es=z(te,[["render",Je],["__scopeId","data-v-80d769da"]]);export{es as default};
