import{_ as Y,u as Z,p as $,r,i as ee,j as h,o as C,c as k,b as o,k as m,t as I,d as oe,e as d,g as S,v as M,y as T,n as se,a as ae,F as te,l as F}from"./index-44082a31.js";import{F as le,N as re,_ as ne,a as v}from"./sidebar-bb23d596.js";import{C as ie,U as de}from"./UploadAdapter-ca17a361.js";import{s as ce}from"./vue-multiselect.css_vue_type_style_index_0_src_true_lang-24d78724.js";const ue={components:{Footer:le,Navbar:re,Sidebar:ne,multiselect:ce},setup(){const p=Z(),e=$(),U=r(null),a=r(null),V=r(!1),f=r(""),y=r({}),_=r(!1),n=r(!1),g=r(""),s=r({title:"",instructor:"",subtitle:"",has_certificate:!1,language:"",description:"",category:"",tags:[],chapters:[],status:"",is_mandatory:!1,credit:0,coverImage:null}),L=r([]),P=r([]),H=r([]),N=r(""),R=r(""),A=r([]),j=({name:t,position:l})=>`${t} (${l})`,D=async()=>{try{const t=p.params.id,l=await v.getCourse(t);await E(),s.value={title:l.title,subtitle:l.subtitle,has_certificate:l.has_certificate,language:l.language,instructors:l.instructors,description:l.description,category:l.categories[0],tags:l.tags,status:l.status,coverImage:l.media[0]?l.media[0].media_url:"",is_mandatory:l.is_mandatory,credit:l.credit},a.value=s.value.coverImage}catch(t){console.log(t)}},E=async()=>{try{const t=await v.getInstructorsOption();A.value=t.map(l=>({id:l.id,name:l.name,position:l.position||""}))}catch(t){console.log(t)}},B=async()=>{try{const t=await v.getTags({type:"tag"});P.value=t.data}catch(t){console.log(t)}},O=async()=>{try{const t=await v.getTags({type:"category"});L.value=t.data}catch(t){console.log(t)}},Q=t=>{s.value.instructor=t.name,N.value=""},w=t=>{g.value=t,n.value=!0},q=t=>{g.value=t,n.value=!0},W=()=>{n.value=!1},z=async()=>{var t,l,i;try{const c=p.params.id;let u={title:s.value.title,subtitle:s.value.subtitle,has_certificate:s.value.has_certificate,language:s.value.language,instructors:s.value.instructors.map(b=>b.id),description:s.value.description,tags:s.value.tags.map(b=>b.id),status:s.value.status,is_mandatory:s.value.is_mandatory,credit:s.value.credit,coverImage:s.value.coverImage};(t=s.value.category)!=null&&t.id&&(u.categories=[s.value.category.id]),await v.updateCourse(c,u),e.push({name:"courseList"})}catch(c){if(((i=(l=c.response)==null?void 0:l.data)==null?void 0:i.status)==="error")if(c.response.data.content){const u={};for(const[X,x]of Object.entries(c.response.data.content))u[X]=Array.isArray(x)?x[0].replace(/[\[\]"]/g,""):x;y.value=u;const b=Object.values(u).join("<br/>");w("新增失敗："+(b||"未知錯誤"))}else w("新增失敗："+(c.response.data.message||"儲存失敗"));else w("儲存失敗")}finally{_.value=!1}},G=async t=>{const l=t.target.files[0];if(l)try{V.value=!0,f.value="上傳中...";const i=await v.courseImgUpload(l);s.value.coverImage=i.url,a.value=i.url,f.value="上傳完成"}catch(i){f.value="上傳失敗："+i.message,s.value.coverImage="",t.target.value=""}finally{V.value=!1}},J=()=>{a.value=null,s.value.coverImage=null};ee(async()=>{try{B(),O(),E(),await D(),U.value=await ie.create(document.querySelector("#editor"),{removePlugins:["Markdown"],extraPlugins:[K],toolbar:["heading","|","bold","italic","link","bulletedList","numberedList","blockQuote","imageUpload"],heading:{options:[{model:"paragraph",title:"Paragraph",class:"ck-heading_paragraph"},{model:"heading1",view:"h2",title:"Heading 1",class:"ck-heading_heading1"},{model:"heading2",view:"h3",title:"Heading 2",class:"ck-heading_heading2"}]}}).then(t=>(t.model.document.on("change:data",()=>{s.value.description=t.getData()}),t)).catch(t=>{console.error(t)})}catch(t){console.error("資料獲取失敗:",t)}});function K(t){t.plugins.get("FileRepository").createUploadAdapter=l=>new de(l)}return{course:s,categories:L,availableTags:P,selectedTags:H,saveCourse:z,route:p,handleCoverImageUpload:G,removeCoverImage:J,coverImagePreview:a,editor:U,instructorSearchQuery:N,chapterSearchQuery:R,selectInstructor:Q,availableInstructors:A,nameWithPos:j,errors:y,isLoading:_,showModal:n,modalMessage:g,showErrorModal:w,closeModal:W,showSuccessModal:q}}},me={class:"main-wrapper"},ve={class:"page-wrapper"},ge={class:"page-content"},be={class:"row mb-4"},pe={class:"col-12 mx-auto stretch-card"},fe={class:"card"},ye={class:"card-body"},_e={class:"card-title"},we={class:"mb-3"},he={class:"mb-3"},Ce={class:"mb-3"},ke={class:"mb-3"},Ie={class:"row"},Me={class:"mb-3 col-6"},Ue={class:"mb-3 col-6"},Ve={class:"mb-3 col-6"},xe={class:"mb-3 col-6"},Se={class:"mb-3"},Te=["innerHTML"],Le={class:"row"},Pe={class:"col"},Ne={class:"d-flex flex-wrap gap-2"},Ae={class:"d-flex flex-wrap gap-2"},Ee={class:"col"},Fe={class:"cover-image-container"},He={key:0,class:"cover-preview"},Re=["src"],je={key:1,class:"upload-placeholder"},De={class:"d-flex justify-content-end gap-2"},Be={class:"modal-dialog"},Oe={class:"modal-content"},Qe={class:"modal-header"},qe=["innerHTML"],We={class:"modal-footer"},ze={key:0,class:"modal-backdrop"};function Ge(p,e,U,a,V,f){const y=h("Sidebar"),_=h("Navbar"),n=h("multiselect"),g=h("router-link");return C(),k(te,null,[o("div",me,[m(y),o("div",ve,[m(_),o("div",ge,[o("div",be,[o("div",pe,[o("div",fe,[o("div",ye,[o("h6",_e,I(a.route.params.id?"編輯課程":"新增課程"),1),o("form",{onSubmit:e[12]||(e[12]=oe((...s)=>a.saveCourse&&a.saveCourse(...s),["prevent"]))},[o("div",we,[e[15]||(e[15]=o("label",{class:"form-label"},"課程標題",-1)),d(o("input",{type:"text",class:"form-control","onUpdate:modelValue":e[0]||(e[0]=s=>a.course.title=s),required:""},null,512),[[S,a.course.title]])]),o("div",he,[e[16]||(e[16]=o("label",{class:"form-label"},"副標題",-1)),d(o("input",{"onUpdate:modelValue":e[1]||(e[1]=s=>a.course.subtitle=s),type:"text",class:"form-control",maxlength:"100"},null,512),[[S,a.course.subtitle]])]),o("div",Ce,[e[18]||(e[18]=o("label",{class:"form-label"},"是否有證書",-1)),d(o("select",{"onUpdate:modelValue":e[2]||(e[2]=s=>a.course.has_certificate=s),class:"form-select"},e[17]||(e[17]=[o("option",{value:"0"},"否",-1),o("option",{value:"1"},"是",-1)]),512),[[M,a.course.has_certificate]])]),o("div",ke,[e[20]||(e[20]=o("label",{class:"form-label"},"課程語言",-1)),d(o("select",{"onUpdate:modelValue":e[3]||(e[3]=s=>a.course.language=s),class:"form-select"},e[19]||(e[19]=[o("option",{value:""},"請選擇語言",-1),o("option",{value:"中文"},"中文",-1),o("option",{value:"英文"},"英文",-1)]),512),[[M,a.course.language]])]),o("div",Ie,[o("div",Me,[e[21]||(e[21]=o("label",{class:"form-label"},"講師",-1)),m(n,{modelValue:a.course.instructors,"onUpdate:modelValue":e[4]||(e[4]=s=>a.course.instructors=s),options:a.availableInstructors,"custom-label":a.nameWithPos,placeholder:"Select one",label:"name","track-by":"name","aria-label":"pick a value",multiple:!0},{singleLabel:T(({option:s})=>[o("strong",null,I(s.name),1),F(" ("+I(s.position)+")",1)]),_:1},8,["modelValue","options","custom-label"])]),o("div",Ue,[e[23]||(e[23]=o("label",{class:"form-label"},"課程屬性",-1)),d(o("select",{class:"form-control","onUpdate:modelValue":e[5]||(e[5]=s=>a.course.is_mandatory=s)},e[22]||(e[22]=[o("option",{value:"1"},"必修",-1),o("option",{value:"0"},"選修",-1)]),512),[[M,a.course.is_mandatory]])]),o("div",Ve,[e[24]||(e[24]=o("label",{class:"form-label"},"學分數",-1)),d(o("input",{type:"number",class:"form-control","onUpdate:modelValue":e[6]||(e[6]=s=>a.course.credit=s),min:"0",step:"1"},null,512),[[S,a.course.credit]])]),o("div",xe,[e[25]||(e[25]=o("label",{class:"form-label"},"課程分類",-1)),m(n,{modelValue:a.course.category,"onUpdate:modelValue":e[7]||(e[7]=s=>a.course.category=s),options:a.categories,placeholder:"Select one",label:"name","track-by":"name","aria-label":"pick a value"},{singleLabel:T(({option:s})=>[o("strong",null,I(s.name),1)]),_:1},8,["modelValue","options"])])]),o("div",Se,[e[26]||(e[26]=o("label",{class:"form-label"},"課程簡介",-1)),o("div",{id:"editor",innerHTML:a.course.description},null,8,Te)]),o("div",Le,[o("div",Pe,[e[28]||(e[28]=o("label",{class:"form-label"},"狀態",-1)),o("div",Ne,[d(o("select",{class:"form-control","onUpdate:modelValue":e[8]||(e[8]=s=>a.course.status=s)},e[27]||(e[27]=[o("option",{value:"publish"},"公開",-1),o("option",{value:"unpublish"},"非公開",-1)]),512),[[M,a.course.status]])]),e[29]||(e[29]=o("br",null,null,-1)),e[30]||(e[30]=o("label",{class:"form-label"},"課程標籤",-1)),o("div",Ae,[m(n,{id:"tagging",modelValue:a.course.tags,"onUpdate:modelValue":e[9]||(e[9]=s=>a.course.tags=s),"tag-placeholder":"Add this as new tag",placeholder:"Search or add a tag",label:"name","track-by":"id",options:a.availableTags,multiple:!0,taggable:!0},null,8,["modelValue","options"])])]),o("div",Ee,[e[31]||(e[31]=o("label",{class:"form-label"},"課程封面照片",-1)),o("div",Fe,[a.coverImagePreview?(C(),k("div",He,[o("img",{src:a.coverImagePreview,alt:"課程封面預覽"},null,8,Re),o("button",{type:"button",class:"btn btn-danger btn-sm",onClick:e[10]||(e[10]=(...s)=>a.removeCoverImage&&a.removeCoverImage(...s))}," 更換封面 ")])):(C(),k("div",je,[o("input",{type:"file",class:"form-control",accept:"image/*",onChange:e[11]||(e[11]=(...s)=>a.handleCoverImageUpload&&a.handleCoverImageUpload(...s))},null,32)]))])])]),o("div",De,[m(g,{class:"btn btn-secondary me-2",to:{name:"courseList"}},{default:T(()=>e[32]||(e[32]=[F(" 取消 ")])),_:1}),e[33]||(e[33]=o("button",{type:"submit",class:"btn btn-primary"},"儲存",-1))])],32)])])])])])])]),o("div",{class:se(["modal",{"d-block":a.showModal}]),tabindex:"-1"},[o("div",Be,[o("div",Oe,[o("div",Qe,[e[34]||(e[34]=o("h5",{class:"modal-title"},"提示",-1)),o("button",{type:"button",class:"btn-close",onClick:e[13]||(e[13]=(...s)=>a.closeModal&&a.closeModal(...s))})]),o("div",{class:"modal-body",innerHTML:a.modalMessage},null,8,qe),o("div",We,[o("button",{type:"button",class:"btn btn-secondary",onClick:e[14]||(e[14]=(...s)=>a.closeModal&&a.closeModal(...s))},"關閉")])])])],2),a.showModal?(C(),k("div",ze)):ae("",!0)],64)}const Ze=Y(ue,[["render",Ge],["__scopeId","data-v-d1d8cf8b"]]);export{Ze as default};
