import{_ as Z,u as $,p as ee,r as n,i as oe,j as _,o as g,c as w,b as e,k as b,t as k,d as ae,e as c,g as L,v as h,l as T,a as P,y as N,n as se,m as te,F as le}from"./index-25cf0606.js";import{F as re,N as ne,_ as ie,a as p}from"./sidebar-d63d104f.js";import{C as de,U as ce}from"./UploadAdapter-6c20a32c.js";import{s as ue}from"./vue-multiselect.css_vue_type_style_index_0_src_true_lang-66fb716d.js";import{L as me}from"./loading-af52cca8.js";const ve={components:{Footer:re,Navbar:ne,Sidebar:ie,Loading:me,multiselect:ue},setup(){const C=$(),o=ee(),V=n(null),a=n(null),x=n(!1),I=n(""),M=n({}),i=n(!1),d=n(!1),f=n(""),r=n({title:"",instructor:"",subtitle:"",has_certificate:!1,language:"",description:"",category:"",tags:[],chapters:[],status:"",is_mandatory:!1,credit:0,level:"beginner",coverImage:null}),s=n([]),A=n([]),R=n([]),E=n(""),j=n(""),F=n([]),D=({name:t,position:l})=>`${t} (${l})`,B=async()=>{try{const t=C.params.id,l=await p.getCourse(t);await H(),r.value={title:l.title,subtitle:l.subtitle,has_certificate:l.has_certificate,language:l.language,instructors:l.instructors,description:l.description,category:l.categories[0],tags:l.tags,status:l.status,level:l.level,coverImage:l.media[0]?l.media[0].media_url:"",is_mandatory:l.is_mandatory,credit:l.credit},a.value=r.value.coverImage}catch(t){console.log(t)}},H=async()=>{try{const t=await p.getInstructorsOption();F.value=t.map(l=>({id:l.id,name:l.name,position:l.position||""}))}catch(t){console.log(t)}},q=async()=>{try{const t=await p.getTags({type:"tag"});A.value=t.data}catch(t){console.log(t)}},O=async()=>{try{const t=await p.getTags({type:"category"});s.value=t.data}catch(t){console.log(t)}},Q=t=>{r.value.instructor=t.name,E.value=""},U=t=>{f.value=t,d.value=!0},W=t=>{f.value=t,d.value=!0},z=()=>{d.value=!1},G=async()=>{var t,l,u;try{i.value=!0;const m=C.params.id;let v={title:r.value.title,subtitle:r.value.subtitle,has_certificate:r.value.has_certificate,language:r.value.language,instructors:r.value.instructors.map(y=>y.id),description:r.value.description,tags:r.value.tags.map(y=>y.id),status:r.value.status,is_mandatory:r.value.is_mandatory,credit:r.value.credit,level:r.value.level,coverImage:r.value.coverImage};(t=r.value.category)!=null&&t.id&&(v.categories=[r.value.category.id]),await p.updateCourse(m,v),i.value=!1,o.push({name:"courseList"})}catch(m){if(i.value=!1,((u=(l=m.response)==null?void 0:l.data)==null?void 0:u.status)==="error")if(m.response.data.content){const v={};for(const[Y,S]of Object.entries(m.response.data.content))v[Y]=Array.isArray(S)?S[0].replace(/[\[\]"]/g,""):S;M.value=v;const y=Object.values(v).join("<br/>");U("新增失敗："+(y||"未知錯誤"))}else U("新增失敗："+(m.response.data.message||"儲存失敗"));else U("儲存失敗")}finally{i.value=!1}},J=async t=>{const l=t.target.files[0];if(l)try{x.value=!0,I.value="上傳中...";const u=await p.courseImgUpload(l);r.value.coverImage=u.url,a.value=u.url,I.value="上傳完成"}catch(u){I.value="上傳失敗："+u.message,r.value.coverImage="",t.target.value=""}finally{x.value=!1}},K=()=>{a.value=null,r.value.coverImage=null};oe(async()=>{try{i.value=!0,q(),O(),H(),await B(),V.value=await de.create(document.querySelector("#editor"),{removePlugins:["Markdown"],extraPlugins:[X],toolbar:["heading","|","bold","italic","link","bulletedList","numberedList","blockQuote","imageUpload"],heading:{options:[{model:"paragraph",title:"Paragraph",class:"ck-heading_paragraph"},{model:"heading1",view:"h2",title:"Heading 1",class:"ck-heading_heading1"},{model:"heading2",view:"h3",title:"Heading 2",class:"ck-heading_heading2"}]}}).then(t=>(t.model.document.on("change:data",()=>{r.value.description=t.getData()}),t)).catch(t=>{console.error(t)}),i.value=!1}catch(t){console.error("資料獲取失敗:",t)}});function X(t){t.plugins.get("FileRepository").createUploadAdapter=l=>new ce(l)}return{course:r,categories:s,availableTags:A,selectedTags:R,saveCourse:G,route:C,handleCoverImageUpload:J,removeCoverImage:K,coverImagePreview:a,editor:V,instructorSearchQuery:E,chapterSearchQuery:j,selectInstructor:Q,availableInstructors:F,nameWithPos:D,errors:M,loading:i,showModal:d,modalMessage:f,showErrorModal:U,closeModal:z,showSuccessModal:W}}},ge={class:"main-wrapper"},be={class:"page-wrapper"},pe={class:"page-content"},fe={class:"row mb-4"},ye={class:"col-12 mx-auto stretch-card"},_e={class:"card"},we={class:"card-body"},ke={class:"card-title"},he={class:"mb-3"},Ce={class:"mb-3"},Ie={class:"mb-3"},Me={class:"mb-3"},Ue={class:"mb-3"},Ve={key:0,class:"invalid-feedback"},xe={class:"row"},Se={class:"mb-3 col-6"},Le={class:"mb-3 col-6"},Te={class:"mb-3 col-6"},Pe={class:"mb-3 col-6"},Ne={class:"mb-3"},Ae=["innerHTML"],Ee={class:"row"},Fe={class:"col"},He={class:"d-flex flex-wrap gap-2"},Re={class:"d-flex flex-wrap gap-2"},je={class:"col"},De={class:"cover-image-container"},Be={key:0,class:"cover-preview"},qe=["src"],Oe={key:1,class:"upload-placeholder"},Qe={class:"d-flex justify-content-end gap-2"},We={class:"modal-dialog"},ze={class:"modal-content"},Ge={class:"modal-header"},Je=["innerHTML"],Ke={class:"modal-footer"},Xe={key:0,class:"modal-backdrop"};function Ye(C,o,V,a,x,I){const M=_("Sidebar"),i=_("Navbar"),d=_("multiselect"),f=_("router-link"),r=_("Loading");return g(),w(le,null,[e("div",ge,[b(M),e("div",be,[b(i),e("div",pe,[e("div",fe,[e("div",ye,[e("div",_e,[e("div",we,[e("h6",ke,k(a.route.params.id?"編輯課程":"新增課程"),1),e("form",{onSubmit:o[13]||(o[13]=ae((...s)=>a.saveCourse&&a.saveCourse(...s),["prevent"]))},[e("div",he,[o[16]||(o[16]=e("label",{class:"form-label"},"課程標題",-1)),c(e("input",{type:"text",class:"form-control","onUpdate:modelValue":o[0]||(o[0]=s=>a.course.title=s),required:""},null,512),[[L,a.course.title]])]),e("div",Ce,[o[17]||(o[17]=e("label",{class:"form-label"},"副標題",-1)),c(e("input",{"onUpdate:modelValue":o[1]||(o[1]=s=>a.course.subtitle=s),type:"text",class:"form-control",maxlength:"100"},null,512),[[L,a.course.subtitle]])]),e("div",Ie,[o[19]||(o[19]=e("label",{class:"form-label"},"是否有證書",-1)),c(e("select",{"onUpdate:modelValue":o[2]||(o[2]=s=>a.course.has_certificate=s),class:"form-select"},o[18]||(o[18]=[e("option",{value:"0"},"否",-1),e("option",{value:"1"},"是",-1)]),512),[[h,a.course.has_certificate]])]),e("div",Me,[o[21]||(o[21]=e("label",{class:"form-label"},"課程語言",-1)),c(e("select",{"onUpdate:modelValue":o[3]||(o[3]=s=>a.course.language=s),class:"form-select"},o[20]||(o[20]=[e("option",{value:""},"請選擇語言",-1),e("option",{value:"中文"},"中文",-1),e("option",{value:"英文"},"英文",-1)]),512),[[h,a.course.language]])]),e("div",Ue,[o[23]||(o[23]=e("label",{class:"form-label"},[T("課程等級 "),e("span",{class:"text-danger"},"*")],-1)),c(e("select",{"onUpdate:modelValue":o[4]||(o[4]=s=>a.course.level=s),class:"form-select",required:""},o[22]||(o[22]=[e("option",{value:"beginner"},"初級",-1),e("option",{value:"intermediate"},"中級",-1),e("option",{value:"advanced"},"高級",-1),e("option",{value:"all_levels"},"全等級",-1)]),512),[[h,a.course.level]]),a.errors.level?(g(),w("div",Ve,k(a.errors.level),1)):P("",!0)]),e("div",xe,[e("div",Se,[o[24]||(o[24]=e("label",{class:"form-label"},"講師",-1)),b(d,{modelValue:a.course.instructors,"onUpdate:modelValue":o[5]||(o[5]=s=>a.course.instructors=s),options:a.availableInstructors,"custom-label":a.nameWithPos,placeholder:"Select one",label:"name","track-by":"name","aria-label":"pick a value",multiple:!0},{singleLabel:N(({option:s})=>[e("strong",null,k(s.name),1),T(" ("+k(s.position)+")",1)]),_:1},8,["modelValue","options","custom-label"])]),e("div",Le,[o[26]||(o[26]=e("label",{class:"form-label"},"課程屬性",-1)),c(e("select",{class:"form-control","onUpdate:modelValue":o[6]||(o[6]=s=>a.course.is_mandatory=s)},o[25]||(o[25]=[e("option",{value:"1"},"必修",-1),e("option",{value:"0"},"選修",-1)]),512),[[h,a.course.is_mandatory]])]),e("div",Te,[o[27]||(o[27]=e("label",{class:"form-label"},"學分數",-1)),c(e("input",{type:"number",class:"form-control","onUpdate:modelValue":o[7]||(o[7]=s=>a.course.credit=s),min:"0",step:"1"},null,512),[[L,a.course.credit]])]),e("div",Pe,[o[28]||(o[28]=e("label",{class:"form-label"},"課程分類",-1)),b(d,{modelValue:a.course.category,"onUpdate:modelValue":o[8]||(o[8]=s=>a.course.category=s),options:a.categories,placeholder:"Select one",label:"name","track-by":"name","aria-label":"pick a value"},{singleLabel:N(({option:s})=>[e("strong",null,k(s.name),1)]),_:1},8,["modelValue","options"])])]),e("div",Ne,[o[29]||(o[29]=e("label",{class:"form-label"},"課程簡介",-1)),e("div",{id:"editor",innerHTML:a.course.description},null,8,Ae)]),e("div",Ee,[e("div",Fe,[o[31]||(o[31]=e("label",{class:"form-label"},"狀態",-1)),e("div",He,[c(e("select",{class:"form-control","onUpdate:modelValue":o[9]||(o[9]=s=>a.course.status=s)},o[30]||(o[30]=[e("option",{value:"publish"},"公開",-1),e("option",{value:"unpublish"},"非公開",-1)]),512),[[h,a.course.status]])]),o[32]||(o[32]=e("br",null,null,-1)),o[33]||(o[33]=e("label",{class:"form-label"},"課程標籤",-1)),e("div",Re,[b(d,{id:"tagging",modelValue:a.course.tags,"onUpdate:modelValue":o[10]||(o[10]=s=>a.course.tags=s),"tag-placeholder":"Add this as new tag",placeholder:"Search or add a tag",label:"name","track-by":"id",options:a.availableTags,multiple:!0,taggable:!0},null,8,["modelValue","options"])])]),e("div",je,[o[34]||(o[34]=e("label",{class:"form-label"},"課程封面照片",-1)),e("div",De,[a.coverImagePreview?(g(),w("div",Be,[e("img",{src:a.coverImagePreview,alt:"課程封面預覽"},null,8,qe),e("button",{type:"button",class:"btn btn-danger btn-sm",onClick:o[11]||(o[11]=(...s)=>a.removeCoverImage&&a.removeCoverImage(...s))}," 更換封面 ")])):(g(),w("div",Oe,[e("input",{type:"file",class:"form-control",accept:"image/*",onChange:o[12]||(o[12]=(...s)=>a.handleCoverImageUpload&&a.handleCoverImageUpload(...s))},null,32)]))])])]),e("div",Qe,[b(f,{class:"btn btn-secondary me-2",to:{name:"courseList"}},{default:N(()=>o[35]||(o[35]=[T(" 取消 ")])),_:1}),o[36]||(o[36]=e("button",{type:"submit",class:"btn btn-primary"},"儲存",-1))])],32)])])])])])])]),e("div",{class:se(["modal",{"d-block":a.showModal}]),tabindex:"-1"},[e("div",We,[e("div",ze,[e("div",Ge,[o[37]||(o[37]=e("h5",{class:"modal-title"},"提示",-1)),e("button",{type:"button",class:"btn-close",onClick:o[14]||(o[14]=(...s)=>a.closeModal&&a.closeModal(...s))})]),e("div",{class:"modal-body",innerHTML:a.modalMessage},null,8,Je),e("div",Ke,[e("button",{type:"button",class:"btn btn-secondary",onClick:o[15]||(o[15]=(...s)=>a.closeModal&&a.closeModal(...s))},"關閉")])])])],2),a.showModal?(g(),w("div",Xe)):P("",!0),a.loading?(g(),te(r,{key:1})):P("",!0)],64)}const so=Z(ve,[["render",Ye],["__scopeId","data-v-c185b208"]]);export{so as default};
