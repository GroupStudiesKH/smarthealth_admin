import{_ as Z,u as $,p as ee,r,i as oe,j as M,o as p,c as f,b as e,k as m,t as y,d as se,e as i,g as S,v as _,l as T,a as H,y as L,n as ae,F as te}from"./index-4039d559.js";import{F as le,N as re,_ as ne,a as v}from"./sidebar-6e94c721.js";import{C as ie,U as de}from"./UploadAdapter-79d702a6.js";import{s as ce}from"./vue-multiselect.css_vue_type_style_index_0_src_true_lang-95c70a30.js";const ue={components:{Footer:le,Navbar:re,Sidebar:ne,multiselect:ce},setup(){const w=$(),o=ee(),U=r(null),a=r(null),V=r(!1),k=r(""),h=r({}),C=r(!1),n=r(!1),g=r(""),s=r({title:"",instructor:"",subtitle:"",has_certificate:!1,language:"",description:"",category:"",tags:[],chapters:[],status:"",is_mandatory:!1,credit:0,level:"beginner",coverImage:null}),P=r([]),N=r([]),R=r([]),A=r(""),j=r(""),E=r([]),D=({name:t,position:l})=>`${t} (${l})`,q=async()=>{try{const t=w.params.id,l=await v.getCourse(t);await F(),s.value={title:l.title,subtitle:l.subtitle,has_certificate:l.has_certificate,language:l.language,instructors:l.instructors,description:l.description,category:l.categories[0],tags:l.tags,status:l.status,level:l.level,coverImage:l.media[0]?l.media[0].media_url:"",is_mandatory:l.is_mandatory,credit:l.credit},a.value=s.value.coverImage}catch(t){console.log(t)}},F=async()=>{try{const t=await v.getInstructorsOption();E.value=t.map(l=>({id:l.id,name:l.name,position:l.position||""}))}catch(t){console.log(t)}},B=async()=>{try{const t=await v.getTags({type:"tag"});N.value=t.data}catch(t){console.log(t)}},O=async()=>{try{const t=await v.getTags({type:"category"});P.value=t.data}catch(t){console.log(t)}},Q=t=>{s.value.instructor=t.name,A.value=""},I=t=>{g.value=t,n.value=!0},W=t=>{g.value=t,n.value=!0},z=()=>{n.value=!1},G=async()=>{var t,l,d;try{const c=w.params.id;let u={title:s.value.title,subtitle:s.value.subtitle,has_certificate:s.value.has_certificate,language:s.value.language,instructors:s.value.instructors.map(b=>b.id),description:s.value.description,tags:s.value.tags.map(b=>b.id),status:s.value.status,is_mandatory:s.value.is_mandatory,credit:s.value.credit,level:s.value.level,coverImage:s.value.coverImage};(t=s.value.category)!=null&&t.id&&(u.categories=[s.value.category.id]),await v.updateCourse(c,u),o.push({name:"courseList"})}catch(c){if(((d=(l=c.response)==null?void 0:l.data)==null?void 0:d.status)==="error")if(c.response.data.content){const u={};for(const[Y,x]of Object.entries(c.response.data.content))u[Y]=Array.isArray(x)?x[0].replace(/[\[\]"]/g,""):x;h.value=u;const b=Object.values(u).join("<br/>");I("新增失敗："+(b||"未知錯誤"))}else I("新增失敗："+(c.response.data.message||"儲存失敗"));else I("儲存失敗")}finally{C.value=!1}},J=async t=>{const l=t.target.files[0];if(l)try{V.value=!0,k.value="上傳中...";const d=await v.courseImgUpload(l);s.value.coverImage=d.url,a.value=d.url,k.value="上傳完成"}catch(d){k.value="上傳失敗："+d.message,s.value.coverImage="",t.target.value=""}finally{V.value=!1}},K=()=>{a.value=null,s.value.coverImage=null};oe(async()=>{try{B(),O(),F(),await q(),U.value=await ie.create(document.querySelector("#editor"),{removePlugins:["Markdown"],extraPlugins:[X],toolbar:["heading","|","bold","italic","link","bulletedList","numberedList","blockQuote","imageUpload"],heading:{options:[{model:"paragraph",title:"Paragraph",class:"ck-heading_paragraph"},{model:"heading1",view:"h2",title:"Heading 1",class:"ck-heading_heading1"},{model:"heading2",view:"h3",title:"Heading 2",class:"ck-heading_heading2"}]}}).then(t=>(t.model.document.on("change:data",()=>{s.value.description=t.getData()}),t)).catch(t=>{console.error(t)})}catch(t){console.error("資料獲取失敗:",t)}});function X(t){t.plugins.get("FileRepository").createUploadAdapter=l=>new de(l)}return{course:s,categories:P,availableTags:N,selectedTags:R,saveCourse:G,route:w,handleCoverImageUpload:J,removeCoverImage:K,coverImagePreview:a,editor:U,instructorSearchQuery:A,chapterSearchQuery:j,selectInstructor:Q,availableInstructors:E,nameWithPos:D,errors:h,isLoading:C,showModal:n,modalMessage:g,showErrorModal:I,closeModal:z,showSuccessModal:W}}},me={class:"main-wrapper"},ve={class:"page-wrapper"},ge={class:"page-content"},be={class:"row mb-4"},pe={class:"col-12 mx-auto stretch-card"},fe={class:"card"},ye={class:"card-body"},_e={class:"card-title"},we={class:"mb-3"},ke={class:"mb-3"},he={class:"mb-3"},Ce={class:"mb-3"},Ie={class:"mb-3"},Me={key:0,class:"invalid-feedback"},Ue={class:"row"},Ve={class:"mb-3 col-6"},xe={class:"mb-3 col-6"},Se={class:"mb-3 col-6"},Te={class:"mb-3 col-6"},Le={class:"mb-3"},Pe=["innerHTML"],Ne={class:"row"},Ae={class:"col"},Ee={class:"d-flex flex-wrap gap-2"},Fe={class:"d-flex flex-wrap gap-2"},He={class:"col"},Re={class:"cover-image-container"},je={key:0,class:"cover-preview"},De=["src"],qe={key:1,class:"upload-placeholder"},Be={class:"d-flex justify-content-end gap-2"},Oe={class:"modal-dialog"},Qe={class:"modal-content"},We={class:"modal-header"},ze=["innerHTML"],Ge={class:"modal-footer"},Je={key:0,class:"modal-backdrop"};function Ke(w,o,U,a,V,k){const h=M("Sidebar"),C=M("Navbar"),n=M("multiselect"),g=M("router-link");return p(),f(te,null,[e("div",me,[m(h),e("div",ve,[m(C),e("div",ge,[e("div",be,[e("div",pe,[e("div",fe,[e("div",ye,[e("h6",_e,y(a.route.params.id?"編輯課程":"新增課程"),1),e("form",{onSubmit:o[13]||(o[13]=se((...s)=>a.saveCourse&&a.saveCourse(...s),["prevent"]))},[e("div",we,[o[16]||(o[16]=e("label",{class:"form-label"},"課程標題",-1)),i(e("input",{type:"text",class:"form-control","onUpdate:modelValue":o[0]||(o[0]=s=>a.course.title=s),required:""},null,512),[[S,a.course.title]])]),e("div",ke,[o[17]||(o[17]=e("label",{class:"form-label"},"副標題",-1)),i(e("input",{"onUpdate:modelValue":o[1]||(o[1]=s=>a.course.subtitle=s),type:"text",class:"form-control",maxlength:"100"},null,512),[[S,a.course.subtitle]])]),e("div",he,[o[19]||(o[19]=e("label",{class:"form-label"},"是否有證書",-1)),i(e("select",{"onUpdate:modelValue":o[2]||(o[2]=s=>a.course.has_certificate=s),class:"form-select"},o[18]||(o[18]=[e("option",{value:"0"},"否",-1),e("option",{value:"1"},"是",-1)]),512),[[_,a.course.has_certificate]])]),e("div",Ce,[o[21]||(o[21]=e("label",{class:"form-label"},"課程語言",-1)),i(e("select",{"onUpdate:modelValue":o[3]||(o[3]=s=>a.course.language=s),class:"form-select"},o[20]||(o[20]=[e("option",{value:""},"請選擇語言",-1),e("option",{value:"中文"},"中文",-1),e("option",{value:"英文"},"英文",-1)]),512),[[_,a.course.language]])]),e("div",Ie,[o[23]||(o[23]=e("label",{class:"form-label"},[T("課程等級 "),e("span",{class:"text-danger"},"*")],-1)),i(e("select",{"onUpdate:modelValue":o[4]||(o[4]=s=>a.course.level=s),class:"form-select",required:""},o[22]||(o[22]=[e("option",{value:"beginner"},"初級",-1),e("option",{value:"intermediate"},"中級",-1),e("option",{value:"advanced"},"高級",-1),e("option",{value:"all_levels"},"全等級",-1)]),512),[[_,a.course.level]]),a.errors.level?(p(),f("div",Me,y(a.errors.level),1)):H("",!0)]),e("div",Ue,[e("div",Ve,[o[24]||(o[24]=e("label",{class:"form-label"},"講師",-1)),m(n,{modelValue:a.course.instructors,"onUpdate:modelValue":o[5]||(o[5]=s=>a.course.instructors=s),options:a.availableInstructors,"custom-label":a.nameWithPos,placeholder:"Select one",label:"name","track-by":"name","aria-label":"pick a value",multiple:!0},{singleLabel:L(({option:s})=>[e("strong",null,y(s.name),1),T(" ("+y(s.position)+")",1)]),_:1},8,["modelValue","options","custom-label"])]),e("div",xe,[o[26]||(o[26]=e("label",{class:"form-label"},"課程屬性",-1)),i(e("select",{class:"form-control","onUpdate:modelValue":o[6]||(o[6]=s=>a.course.is_mandatory=s)},o[25]||(o[25]=[e("option",{value:"1"},"必修",-1),e("option",{value:"0"},"選修",-1)]),512),[[_,a.course.is_mandatory]])]),e("div",Se,[o[27]||(o[27]=e("label",{class:"form-label"},"學分數",-1)),i(e("input",{type:"number",class:"form-control","onUpdate:modelValue":o[7]||(o[7]=s=>a.course.credit=s),min:"0",step:"1"},null,512),[[S,a.course.credit]])]),e("div",Te,[o[28]||(o[28]=e("label",{class:"form-label"},"課程分類",-1)),m(n,{modelValue:a.course.category,"onUpdate:modelValue":o[8]||(o[8]=s=>a.course.category=s),options:a.categories,placeholder:"Select one",label:"name","track-by":"name","aria-label":"pick a value"},{singleLabel:L(({option:s})=>[e("strong",null,y(s.name),1)]),_:1},8,["modelValue","options"])])]),e("div",Le,[o[29]||(o[29]=e("label",{class:"form-label"},"課程簡介",-1)),e("div",{id:"editor",innerHTML:a.course.description},null,8,Pe)]),e("div",Ne,[e("div",Ae,[o[31]||(o[31]=e("label",{class:"form-label"},"狀態",-1)),e("div",Ee,[i(e("select",{class:"form-control","onUpdate:modelValue":o[9]||(o[9]=s=>a.course.status=s)},o[30]||(o[30]=[e("option",{value:"publish"},"公開",-1),e("option",{value:"unpublish"},"非公開",-1)]),512),[[_,a.course.status]])]),o[32]||(o[32]=e("br",null,null,-1)),o[33]||(o[33]=e("label",{class:"form-label"},"課程標籤",-1)),e("div",Fe,[m(n,{id:"tagging",modelValue:a.course.tags,"onUpdate:modelValue":o[10]||(o[10]=s=>a.course.tags=s),"tag-placeholder":"Add this as new tag",placeholder:"Search or add a tag",label:"name","track-by":"id",options:a.availableTags,multiple:!0,taggable:!0},null,8,["modelValue","options"])])]),e("div",He,[o[34]||(o[34]=e("label",{class:"form-label"},"課程封面照片",-1)),e("div",Re,[a.coverImagePreview?(p(),f("div",je,[e("img",{src:a.coverImagePreview,alt:"課程封面預覽"},null,8,De),e("button",{type:"button",class:"btn btn-danger btn-sm",onClick:o[11]||(o[11]=(...s)=>a.removeCoverImage&&a.removeCoverImage(...s))}," 更換封面 ")])):(p(),f("div",qe,[e("input",{type:"file",class:"form-control",accept:"image/*",onChange:o[12]||(o[12]=(...s)=>a.handleCoverImageUpload&&a.handleCoverImageUpload(...s))},null,32)]))])])]),e("div",Be,[m(g,{class:"btn btn-secondary me-2",to:{name:"courseList"}},{default:L(()=>o[35]||(o[35]=[T(" 取消 ")])),_:1}),o[36]||(o[36]=e("button",{type:"submit",class:"btn btn-primary"},"儲存",-1))])],32)])])])])])])]),e("div",{class:ae(["modal",{"d-block":a.showModal}]),tabindex:"-1"},[e("div",Oe,[e("div",Qe,[e("div",We,[o[37]||(o[37]=e("h5",{class:"modal-title"},"提示",-1)),e("button",{type:"button",class:"btn-close",onClick:o[14]||(o[14]=(...s)=>a.closeModal&&a.closeModal(...s))})]),e("div",{class:"modal-body",innerHTML:a.modalMessage},null,8,ze),e("div",Ge,[e("button",{type:"button",class:"btn btn-secondary",onClick:o[15]||(o[15]=(...s)=>a.closeModal&&a.closeModal(...s))},"關閉")])])])],2),a.showModal?(p(),f("div",Je)):H("",!0)],64)}const eo=Z(ue,[["render",Ke],["__scopeId","data-v-f7a862b5"]]);export{eo as default};
